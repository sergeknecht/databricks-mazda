# Databricks notebook source
# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_COC_TBCOC_PRODUCT

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_COC_TBCOC_PRODUCT (
# MAGIC     PRODUCTCODE,
# MAGIC     COCNUMBER,
# MAGIC     LINEOFFBEGIN,
# MAGIC     LINEOFFSHIFTLEVEL,
# MAGIC     LINEOFFEND,
# MAGIC     VALUEID,
# MAGIC     STATUS,
# MAGIC     CREATE_USER,
# MAGIC     CREATE_TS,
# MAGIC     UPDATE_USER,
# MAGIC     UPDATE_TS,
# MAGIC     ETL_JOB_NAME,
# MAGIC     SOURCE,
# MAGIC     LOAD_NR
# MAGIC   )
# MAGIC select
# MAGIC   PRODUCTCODE,
# MAGIC   COCNUMBER,
# MAGIC   LINEOFFBEGIN,
# MAGIC   LINEOFFSHIFTLEVEL,
# MAGIC   LINEOFFEND,
# MAGIC   VALUEID,
# MAGIC   STATUS,
# MAGIC   'DWSRV',
# MAGIC   cast(getdate() as date),
# MAGIC   'DWSRV',
# MAGIC   cast(getdate() as date),
# MAGIC   'COC  -  TIA  -  STG_COC_TBCOC_PRODUCT',
# MAGIC   'C_SOURCE_COC',
# MAGIC   'V_DWH_LOAD_12C_LOAD_NR'
# MAGIC from
# MAGIC   bronze.lztbcoc_product

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_COC_TBCOC_VALUE

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_COC_TBCOC_VALUE (
# MAGIC     DISTRIBUTOR,
# MAGIC     LANGUAGE,
# MAGIC     COCNUMBER,
# MAGIC     VALUEID,
# MAGIC     VALUE,
# MAGIC     STATUS,
# MAGIC     CREATE_USER,
# MAGIC     CREATE_TS,
# MAGIC     UPDATE_USER,
# MAGIC     UPDATE_TS,
# MAGIC     ETL_JOB_NAME,
# MAGIC     SOURCE,
# MAGIC     LOAD_NR
# MAGIC   )
# MAGIC select
# MAGIC   DISTRIBUTOR,
# MAGIC   LANGUAGE,
# MAGIC   COCNUMBER,
# MAGIC   VALUEID,
# MAGIC   VALUE,
# MAGIC   STATUS,
# MAGIC   'DWSRV',
# MAGIC   cast(getdate() as date),
# MAGIC   'DWSRV',
# MAGIC   cast(getdate() as date),
# MAGIC   'COC  -  TIA  -  STG_COC_TBCOC_VALUE',
# MAGIC   'C_SOURCE_COC',
# MAGIC   'V_DWH_LOAD_12C_LOAD_NR'
# MAGIC FROM
# MAGIC   bronze.lztbcoc_value

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_EMOT_BTNCOCV

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_EMOT_BTNCOCV (
# MAGIC     VIN,
# MAGIC     DISTCD,
# MAGIC     MODEL,
# MAGIC     SPEC_CODE,
# MAGIC     EXT_COL_CD,
# MAGIC     INT_COL_CD,
# MAGIC     FCT_CLAS,
# MAGIC     BSC,
# MAGIC     LINE_OFF_DT,
# MAGIC     COC_DT,
# MAGIC     NSC_ID,
# MAGIC     L_UPD_TST,
# MAGIC     L_UPD_USR,
# MAGIC     SEND_FLG,
# MAGIC     SEND_TST,
# MAGIC     SEND_NBR,
# MAGIC     END_OF_SERIE
# MAGIC   )
# MAGIC SELECT
# MAGIC   VIN,
# MAGIC   DISTCD,
# MAGIC   MODEL,
# MAGIC   SPEC_CODE,
# MAGIC   EXT_COL_CD,
# MAGIC   INT_COL_CD,
# MAGIC   FCT_CLAS,
# MAGIC   BSC,
# MAGIC   LINE_OFF_DT,
# MAGIC   COC_DT,
# MAGIC   NSC_ID,
# MAGIC   L_UPD_TST,
# MAGIC   L_UPD_USR,
# MAGIC   SEND_FLG,
# MAGIC   SEND_TST,
# MAGIC   SEND_NBR,
# MAGIC   END_OF_SERIE
# MAGIC FROM
# MAGIC   bronze.lzbtncocv

# COMMAND ----------

# %sql
# Insert into
#   silver.STG_TMP_COC_ACTIVE_PRODUCTS (PRODUCTCODE)
# SELECT
#   DISTINCT cast(concat(trim(MODEL), trim(SPEC_CODE)) as STRING) AS PRODUCTCODE
# FROM
#   silver.stg_emot_btncocv
# WHERE
#   (
#     trim(LINE_OFF_DT) <> '000000000'
#     and to_date(
#       substr(STG_EMOT_BTNCOCV.LINE_OFF_DT, 1, 8),
#       'yyyyMMdd'
#     ) >= add_months(trunc(getdate(), 'Month'), -48)
#   )

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_TMP_COC_ACTIVE_PRODUCTS

# COMMAND ----------

df_active_product = (
    spark.read.option('inferSchema', 'true')
    .option('header', 'true')
    .csv('/FileStore/tables/COC_PRODUCT.csv')
)
display(df_active_product)
df_active_product.createOrReplaceTempView('active_product')

# COMMAND ----------

# MAGIC %sql
# MAGIC Insert into silver.STG_TMP_COC_ACTIVE_PRODUCTS
# MAGIC select trim(PRODUCTCODE) from  active_product

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_TMP_COC_TYPE_APPROVAL_HIST

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_TMP_COC_TYPE_APPROVAL_HIST (
# MAGIC     PRODUCTCODE,
# MAGIC     LINEOFFBEGIN,
# MAGIC     LINEOFFEND,
# MAGIC     LINEOFFSHIFTLEVEL,
# MAGIC     TYPE_APPROVAL
# MAGIC   )
# MAGIC SELECT
# MAGIC   SP.PRODUCTCODE AS PRODUCTCODE,
# MAGIC   SP.LINEOFFBEGIN AS LINEOFFBEGIN,
# MAGIC   CAST (
# MAGIC     LEAST (
# MAGIC       SP.LINEOFFEND,
# MAGIC       (
# MAGIC         LEAD (SP.LINEOFFBEGIN - 1, 1, SP.LINEOFFEND) OVER (
# MAGIC           PARTITION BY SP.PRODUCTCODE,
# MAGIC           SP.LINEOFFSHIFTLEVEL
# MAGIC           ORDER BY
# MAGIC             SP.LINEOFFBEGIN
# MAGIC         )
# MAGIC       )
# MAGIC     ) AS DATE
# MAGIC   ) AS LINEOFFEND,
# MAGIC   CAST (SP.LINEOFFSHIFTLEVEL AS CHAR(1)) AS LINEOFFSHIFTLEVEL,
# MAGIC   SV.VALUE AS TYPE_APPROVAL
# MAGIC FROM
# MAGIC   silver.stg_coc_tbcoc_product SP
# MAGIC   INNER JOIN silver.stg_coc_tbcoc_value SV ON SP.COCNUMBER = SV.COCNUMBER
# MAGIC   AND SP.VALUEID = SV.VALUEID
# MAGIC   INNER JOIN silver.stg_tmp_coc_active_products SAP ON SAP.PRODUCTCODE = trim(SP.PRODUCTCODE)
# MAGIC WHERE
# MAGIC   (
# MAGIC     SV.COCNUMBER = 10
# MAGIC     AND SV.DISTRIBUTOR = 0
# MAGIC     AND SV.LANGUAGE = 1
# MAGIC     AND SV.STATUS = 2
# MAGIC   )

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_TMP_COC_VARIANT_HIST

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_TMP_COC_VARIANT_HIST (
# MAGIC     PRODUCTCODE,
# MAGIC     LINEOFFBEGIN,
# MAGIC     LINEOFFEND,
# MAGIC     LINEOFFSHIFTLEVEL,
# MAGIC     VARIANT
# MAGIC   )
# MAGIC SELECT
# MAGIC   SP.PRODUCTCODE AS PRODUCTCODE,
# MAGIC   SP.LINEOFFBEGIN AS LINEOFFBEGIN,
# MAGIC   SP.LINEOFFEND AS LINEOFFEND,
# MAGIC   CAST (SP.LINEOFFSHIFTLEVEL AS CHAR(1)) AS LINEOFFSHIFTLEVEL,
# MAGIC   SV.VALUE AS VARIANT
# MAGIC FROM
# MAGIC   silver.stg_coc_tbcoc_product SP
# MAGIC   INNER JOIN silver.stg_tmp_coc_active_products SAP ON SAP.PRODUCTCODE = trim(SP.PRODUCTCODE)
# MAGIC   INNER JOIN silver.stg_coc_tbcoc_value SV ON SP.COCNUMBER = SV.COCNUMBER
# MAGIC   AND SP.VALUEID = SV.VALUEID
# MAGIC WHERE
# MAGIC   (
# MAGIC     SV.COCNUMBER = 3
# MAGIC     AND SV.DISTRIBUTOR = 0
# MAGIC     AND SV.LANGUAGE = 1
# MAGIC     AND SV.STATUS = 2
# MAGIC   )

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_TMP_COC_VERSION_HIST

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO
# MAGIC   silver.STG_TMP_COC_VERSION_HIST (
# MAGIC     PRODUCTCODE,
# MAGIC     LINEOFFBEGIN,
# MAGIC     LINEOFFEND,
# MAGIC     LINEOFFSHIFTLEVEL,
# MAGIC     VERSION
# MAGIC   )
# MAGIC SELECT
# MAGIC   SP.PRODUCTCODE AS PRODUCTCODE,
# MAGIC   SP.LINEOFFBEGIN AS LINEOFFBEGIN,
# MAGIC   SP.LINEOFFEND AS LINEOFFEND,
# MAGIC   CAST (SP.LINEOFFSHIFTLEVEL AS CHAR(1)) AS LINEOFFSHIFTLEVEL,
# MAGIC   SV.VALUE AS VERSION
# MAGIC FROM
# MAGIC   silver.stg_coc_tbcoc_product SP
# MAGIC   INNER JOIN silver.stg_tmp_coc_active_products SAP ON SAP.PRODUCTCODE = trim(SP.PRODUCTCODE)
# MAGIC   INNER JOIN silver.stg_coc_tbcoc_value SV ON SP.COCNUMBER = SV.COCNUMBER
# MAGIC   AND SP.VALUEID = SV.VALUEID
# MAGIC WHERE
# MAGIC   (
# MAGIC     SV.COCNUMBER = 4
# MAGIC     AND SV.DISTRIBUTOR = 0
# MAGIC     AND SV.LANGUAGE = 1
# MAGIC     AND SV.STATUS = 2
# MAGIC   )

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.IOT_DIM_COC_TYPE_APPROVAL

# COMMAND ----------

# MAGIC %sql
# MAGIC
# MAGIC INSERT INTO silver.IOT_DIM_COC_TYPE_APPROVAL
# MAGIC (
# MAGIC 	PRODUCTCODE ,
# MAGIC 	LINEOFFBEGIN ,
# MAGIC 	LINEOFFEND ,
# MAGIC 	LINEOFFSHIFTLEVEL  ,
# MAGIC   TYPE_APPROVAL_SK ,
# MAGIC 	CREATE_USER ,
# MAGIC 	CREATE_TS ,
# MAGIC 	UPDATE_USER ,
# MAGIC 	UPDATE_TS ,
# MAGIC 	ETL_JOB_NAME ,
# MAGIC 	SOURCE ,
# MAGIC 	LOAD_NR
# MAGIC )
# MAGIC SELECT
# MAGIC   DISTINCT BP.PRODUCTCODE,
# MAGIC   BP.LINEOFFBEGIN,
# MAGIC   lead(
# MAGIC     BP.LINEOFFBEGIN - 1,
# MAGIC     1,
# MAGIC     to_date('99991231', 'yyyyMMdd')
# MAGIC   ) over (
# MAGIC     partition by BP.PRODUCTCODE,
# MAGIC     BP.LINEOFFSHIFTLEVEL
# MAGIC     order by
# MAGIC       BP.LINEOFFBEGIN
# MAGIC   ) LINEOFFEND,
# MAGIC   BP.LINEOFFSHIFTLEVEL,
# MAGIC   null as TYPE_APPROVAL_SK,
# MAGIC 	'DWSRV',
# MAGIC 	getdate(),
# MAGIC 	'DWSRV',
# MAGIC 	getdate(),
# MAGIC 	'COC  -  TBCOC_PRODUCT  -  CTAS  -  IOT_DIM_COC_TYPE_APPROVAL',
# MAGIC 	'C_SOURCE_COC',
# MAGIC 	'V_DWH_LOAD_12C_LOAD_NR'
# MAGIC FROM
# MAGIC   bronze.lztbcoc_product BP
# MAGIC WHERE
# MAGIC   (
# MAGIC     BP.COCNUMBER in (10, 3, 4)
# MAGIC     AND BP.STATUS = 2
# MAGIC   )

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE silver.STG_DIM_COC_TYPE_APPROVAL

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO silver.STG_DIM_COC_TYPE_APPROVAL
# MAGIC           ( TYPE_APPROVAL_SK,
# MAGIC             TYPE_APPROVAL,
# MAGIC             VARIANT,
# MAGIC             VERSION,
# MAGIC             PRODUCTCODE,
# MAGIC             LINEOFFSHIFTLEVEL,
# MAGIC             LINEOFFBEGIN,
# MAGIC             LINEOFFEND,
# MAGIC             CREATE_USER,
# MAGIC             CREATE_TS,
# MAGIC             UPDATE_USER,
# MAGIC             UPDATE_TS,
# MAGIC             ETL_JOB_NAME,
# MAGIC             SOURCE,
# MAGIC             LOAD_NR
# MAGIC           )
# MAGIC SELECT
# MAGIC   IOTAP.TYPE_APPROVAL_SK AS TYPE_APPROVAL_SK,
# MAGIC   trim(APH.TYPE_APPROVAL) AS TYPE_APPROVAL,
# MAGIC   trim(VAH.VARIANT) AS VARIANT,
# MAGIC   trim(VSH.VERSION) AS VERSION,
# MAGIC   trim(IOTAP.PRODUCTCODE) AS PRODUCTCODE,
# MAGIC   IOTAP.LINEOFFSHIFTLEVEL AS  LINEOFFSHIFTLEVEL,
# MAGIC   IOTAP.LINEOFFBEGIN AS  LINEOFFBEGIN,
# MAGIC   IOTAP.LINEOFFEND AS LINEOFFEND,
# MAGIC   'DWSRV' AS CREATE_USER,
# MAGIC   cast(getdate() as date)  AS CREATE_TS,
# MAGIC   'DWSRV' AS UPDATE_USER,
# MAGIC   cast(getdate() AS DATE) AS UPDATE_TS,
# MAGIC   'LOOKUP_SK  -  CTAS  -  STG_DIM_COC_TYPE_APPROVAL' AS ETL_JOB_NAME,
# MAGIC   '#MAZDA__BI.C_SOURCE_COC' AS SOURCE,
# MAGIC   null AS LOAD_NR
# MAGIC FROM
# MAGIC   silver.IOT_DIM_COC_TYPE_APPROVAL IOTAP
# MAGIC   INNER JOIN silver.STG_TMP_COC_VERSION_HIST VSH
# MAGIC   ON IOTAP.PRODUCTCODE = VSH.PRODUCTCODE
# MAGIC   AND IOTAP.LINEOFFSHIFTLEVEL = VSH.LINEOFFSHIFTLEVEL
# MAGIC   AND IOTAP.LINEOFFBEGIN BETWEEN VSH.LINEOFFBEGIN AND VSH.LINEOFFEND
# MAGIC   INNER JOIN  silver.STG_TMP_COC_VARIANT_HIST VAH
# MAGIC   ON  IOTAP.PRODUCTCODE = VAH.PRODUCTCODE
# MAGIC   AND IOTAP.LINEOFFSHIFTLEVEL = VAH.LINEOFFSHIFTLEVEL
# MAGIC   AND IOTAP.LINEOFFBEGIN BETWEEN VAH.LINEOFFBEGIN AND VAH.LINEOFFEND
# MAGIC   INNER JOIN silver.STG_TMP_COC_TYPE_APPROVAL_HIST APH
# MAGIC   ON IOTAP.PRODUCTCODE = APH.PRODUCTCODE
# MAGIC     AND IOTAP.LINEOFFSHIFTLEVEL = APH.LINEOFFSHIFTLEVEL
# MAGIC     AND IOTAP.LINEOFFBEGIN BETWEEN APH.LINEOFFBEGIN AND APH.LINEOFFEND
# MAGIC

# COMMAND ----------

# MAGIC %sql
# MAGIC TRUNCATE TABLE gold.DIM_COC_TYPE_APPROVAL

# COMMAND ----------

# MAGIC %sql
# MAGIC INSERT INTO gold.DIM_COC_TYPE_APPROVAL
# MAGIC SELECT * FROM silver.STG_DIM_COC_TYPE_APPROVAL
